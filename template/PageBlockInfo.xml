<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-2.1.xsd"
        default-menu-include="false">

    <transition name="getBizServiceDataJson">
        <parameter name="serviceDataTypeEnumId"/>
        <parameter name="phaseStatusId" required="true"/>
        <parameter name="excludeServiceIds"/>
        <parameter name="pageNumber"/>
        <parameter name="pageSize"/>
        <parameter name="searchField"/>
        <parameter name="searchKey"/>
        <parameter name="searchValue"/>
        <actions>
            <log message="--------excludeServiceIds:${excludeServiceIds}"/>
            <if condition="!pageSize">
                <set field="pageSize" value="20"/>
            </if>
            <if condition="!pageNumber">
                <set field="pageNumber" value="1"/>
            </if>
            <if condition="searchKey">
                <then>
                    <entity-find-count entity-name="mantle.mfexcel.h5page.BizService" count-field="bizServiceCount"
                                       cache="true">
                        <econdition field-name="${searchKey}" operator="in" from="searchValue.split(',') as List"/>
                        <econdition field-name="serviceDataTypeEnumId" from="serviceDataTypeEnumId" ignore-if-empty="true"/>
                        <econdition field-name="serviceId" operator="not-in" from="excludeServiceIds" ignore-if-empty="true"/>
                        <econdition field-name="phaseStatusId" from="phaseStatusId"/>
                        <econdition field-name="thruDate" operator="is-null"/>
                    </entity-find-count>
                    <entity-find entity-name="mantle.mfexcel.h5page.BizService" list="bizServiceList"
                                 cache="true" limit="20" offset="(pageNumber-1)*pageSize">
                        <econdition field-name="${searchKey}" operator="in" from="searchValue.split(',') as List"/>
                        <econdition field-name="serviceDataTypeEnumId" from="serviceDataTypeEnumId" ignore-if-empty="true"/>
                        <econdition field-name="serviceId" operator="not-in" from="excludeServiceIds" ignore-if-empty="true"/>
                        <econdition field-name="phaseStatusId" from="phaseStatusId"/>
                        <econdition field-name="thruDate" operator="is-null"/>
                        <order-by field-name="serviceId"/>
                    </entity-find>
                </then>
                <else-if condition="searchField">
                    <entity-find-count entity-name="mantle.mfexcel.h5page.BizService" count-field="bizServiceCount"
                                       cache="true">
                        <econditions combine="or">
                            <econdition field-name="serviceId" value="${searchField}"/>
                            <econdition field-name="name" value="${'%'+searchField+'%'}" operator="like"/>
                            <econdition field-name="url" value="${'%'+searchField+'%'}" operator="like"/>
                        </econditions>
                        <econdition field-name="serviceDataTypeEnumId" from="serviceDataTypeEnumId" ignore-if-empty="true"/>
                        <econdition field-name="serviceId" operator="not-in" from="excludeServiceIds" ignore-if-empty="true"/>
                        <econdition field-name="phaseStatusId" from="phaseStatusId"/>
                        <econdition field-name="thruDate" operator="is-null"/>
                    </entity-find-count>

                    <entity-find entity-name="mantle.mfexcel.h5page.BizService" list="bizServiceList" limit="20" offset="(pageNumber-1)*pageSize"
                                 cache="true">
                        <econditions combine="or">
                            <econdition field-name="serviceId" value="${searchField}"/>
                            <econdition field-name="name" value="${'%'+searchField+'%'}" operator="like"/>
                            <econdition field-name="url" value="${'%'+searchField+'%'}" operator="like"/>
                        </econditions>
                        <econdition field-name="serviceDataTypeEnumId" from="serviceDataTypeEnumId" ignore-if-empty="true"/>
                        <econdition field-name="serviceId" operator="not-in" from="excludeServiceIds" ignore-if-empty="true"/>
                        <econdition field-name="phaseStatusId" from="phaseStatusId"/>
                        <econdition field-name="thruDate" operator="is-null"/>
                        <order-by field-name="partyId"/>
                    </entity-find>
                </else-if>
                <else>
                    <!-- 默认初始化查询 -->
                    <entity-find-count entity-name="mantle.mfexcel.h5page.BizService" count-field="bizServiceCount"
                                       cache="true">
                        <econdition field-name="serviceDataTypeEnumId" from="serviceDataTypeEnumId" ignore-if-empty="true"/>
                        <econdition field-name="serviceId" operator="not-in" from="excludeServiceIds" ignore-if-empty="true"/>
                        <econdition field-name="phaseStatusId" from="phaseStatusId"/>
                        <econdition field-name="thruDate" operator="is-null"/>
                    </entity-find-count>
                    <entity-find entity-name="mantle.mfexcel.h5page.BizService" list="bizServiceList" limit="20" offset="(pageNumber-1)*pageSize"
                                 cache="true">
                        <econdition field-name="serviceDataTypeEnumId" from="serviceDataTypeEnumId" ignore-if-empty="true"/>
                        <econdition field-name="serviceId" operator="not-in" from="excludeServiceIds" ignore-if-empty="true"/>
                        <econdition field-name="phaseStatusId" from="phaseStatusId"/>
                        <econdition field-name="thruDate" operator="is-null"/>
                        <order-by field-name="partyId"/>
                    </entity-find>
                </else>
            </if>
            <set field="showBizServiceList" from="[]"/>
            <iterate list="bizServiceList" entry="bizService">
                <set field="showBizServiceMap" from="[:]"/>
                <set field="showBizServiceMap.serviceId" from="bizService?.serviceId"/>
                <set field="showBizServiceMap.pseudoId" from="bizService.pseudoId"/>
                <set field="showBizServiceMap.name" from="bizService?.name"/>
                <set field="showBizServiceMap.serviceDataTypeEnumId" from="bizService.serviceDataTypeEnumId"/>
                <set field="showBizServiceMap.url" from="bizService?.url"/>
                <set field="showBizServiceMap.appPackage" from="bizService?.appPackage"/>
                <set field="showBizServiceMap.searchField" from="bizService.serviceId+bizService.name+bizService.url"/>
                <script>
                    showBizServiceList.add(showBizServiceMap)
                </script>
            </iterate>

            <set field="result"
                 from="['values':['gridResult':['totalRow':bizServiceCount,'list':showBizServiceList]]]"/>
            <script>
                ec.web.sendJsonResponse(result)
            </script>
        </actions>
        <default-response type="none"/>
    </transition>

    <widgets>
    </widgets>
</screen>
